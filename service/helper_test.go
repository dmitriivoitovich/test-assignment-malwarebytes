package service

import (
	"testing"
	"time"

	"github.com/dmitriivoitovich/test-assignment-malwarebytes/repository/db"
	"github.com/umahmood/haversine"
)

func TestTravelSpeed(t *testing.T) {
	type testCase struct {
		from          *EventWithLocation
		to            *EventWithLocation
		expectedSpeed uint64
	}

	testCases := []testCase{
		{
			from: &EventWithLocation{
				event:    &db.Event{Timestamp: 0},
				location: &Location{Latitude: 0, Longitude: 0},
			},
			to: &EventWithLocation{
				event:    &db.Event{Timestamp: 0},
				location: &Location{Latitude: 0, Longitude: 0},
			},
			expectedSpeed: 0,
		},
		{
			from: &EventWithLocation{
				event:    &db.Event{Timestamp: 0},
				location: &Location{Latitude: 0, Longitude: 0},
			},
			to: &EventWithLocation{
				event:    &db.Event{Timestamp: 0},
				location: &Location{Latitude: 10, Longitude: 10},
			},
			expectedSpeed: maxUint64,
		},
		{
			from: &EventWithLocation{
				event:    &db.Event{Timestamp: 0},
				location: &Location{Latitude: 0, Longitude: 0},
			},
			to: &EventWithLocation{
				event:    &db.Event{Timestamp: uint64(time.Hour.Seconds() * 18)},
				location: &Location{Latitude: 10, Longitude: 10},
			},
			expectedSpeed: 54,
		},
		{
			from: &EventWithLocation{
				event:    &db.Event{Timestamp: uint64(time.Hour.Seconds() * 18)},
				location: &Location{Latitude: 0, Longitude: 0},
			},
			to: &EventWithLocation{
				event:    &db.Event{Timestamp: 0},
				location: &Location{Latitude: 10, Longitude: 10},
			},
			expectedSpeed: 54,
		},
		{
			from: &EventWithLocation{
				event:    &db.Event{Timestamp: uint64(time.Hour.Seconds() * 18)},
				location: &Location{Latitude: 0, Longitude: 0},
			},
			to: &EventWithLocation{
				event:    &db.Event{Timestamp: 0},
				location: &Location{Latitude: 10, Longitude: 10, AccuracyRadius: 100},
			},
			expectedSpeed: 58,
		},
		{
			from: &EventWithLocation{
				event:    &db.Event{Timestamp: uint64(time.Hour.Seconds() * 18)},
				location: &Location{Latitude: 0, Longitude: 0, AccuracyRadius: 100},
			},
			to: &EventWithLocation{
				event:    &db.Event{Timestamp: 0},
				location: &Location{Latitude: 10, Longitude: 10, AccuracyRadius: 100},
			},
			expectedSpeed: 61,
		},
	}

	for i := range testCases {
		t.Run("", func(t *testing.T) {
			speed := travelSpeed(testCases[i].from, testCases[i].to)
			if speed != testCases[i].expectedSpeed {
				t.Errorf("TravelSpeed test #%v failed: expected to get %v, but got %v", i, testCases[i].expectedSpeed, speed)
			}
		})
	}
}

func BenchmarkHaversineDistance(b *testing.B) {
	from := haversine.Coord{Lat: 0, Lon: 0}
	to := haversine.Coord{Lat: 10, Lon: 10}

	for n := 0; n < b.N; n++ {
		haversine.Distance(from, to)
	}
}

func BenchmarkTravelSpeed(b *testing.B) {
	from := &EventWithLocation{
		event: &db.Event{
			Timestamp: 0,
		},
		location: &Location{
			Latitude:  0,
			Longitude: 0,
		},
	}
	to := &EventWithLocation{
		event: &db.Event{
			Timestamp: uint64(time.Hour.Seconds()),
		},
		location: &Location{
			Latitude:  10,
			Longitude: 10,
		},
	}

	for n := 0; n < b.N; n++ {
		travelSpeed(from, to)
	}
}
