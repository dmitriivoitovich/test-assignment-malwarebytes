FROM golang:1.16.5-alpine3.13 as builder

# install utils
RUN apk --update add build-base upx

# copy source files into the container
WORKDIR /go/src
COPY . /go/src

# build app binary
RUN GOOS=linux GOARCH=amd64 go build -ldflags="-w -s -extldflags=-static" -tags sqlite_omit_load_extension -o /go/bin/app \
    && upx /go/bin/app


FROM scratch

WORKDIR "/app"

# copy binary and static files from the build container
COPY --from=builder /go/bin/app /app/app
COPY --from=builder /go/src/data /app/data

ENTRYPOINT ["/app/app"]
